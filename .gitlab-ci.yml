# run comment !
image: cedvdb/ss-gitlab-pipeline-docker
stages:
  - install
  - test
  - build
  - staging
  - deploy

# install
app-install:
  stage: install
  allow_failure: false
  script:
    - npm install
    - npm install --save-dev --unsafe-perm node-sass # avoid sass errors
  cache:
    key: cache_key
    paths:
      - node_modules/
  only:
    changes:
      - package-lock.json
  only:
    - development
    - migration-amplify

# tests
app-test:karma:
  stage: test
  image: trion/ng-cli-karma
  allow_failure: false
  cache:
    key: cache_key
    paths:
      - node_modules/
    policy: pull
  script:
    - ng test --code-coverage --progress false --watch false
  coverage: '/Lines \W+: (\d+\.\d+)%.*/'
  artifacts:
    paths:
      - coverage/
  only:
    - development

app-test:e2e:
  stage: test
  image: trion/ng-cli-e2e
  allow_failure: true
  cache:
    key: cache_key
    paths:
      - node_modules/
    policy: pull
  script:
    - npm install
    - ng e2e
  only:
    - development

app-test:lint:
  stage: test
  image: trion/ng-cli
  cache:
    key: cache_key
    paths:
      - node_modules/
    policy: pull
  allow_failure: true
  script:
    - ng lint
  only:
    - development

# build
app-build-test:
  stage: build
  allow_failure: false
  cache:
    key: cache_key
    paths:
      - node_modules/
    policy: pull
  script:
    - npm run version:build && npm run build:dev
  artifacts:
    paths:
      - dist
  only:
    - development

app-build-dev:
  stage: build
  allow_failure: false
  cache:
    key: cache_key
    paths:
      - node_modules/
    policy: pull
  script:
    - git config --global user.email "cedric+1@showsourcing.com"
    - git config --global user.name "CI/CD showsourcing"
    - npm run version:build && npm run build:dev
  artifacts:
    paths:
      - dist
  only:
    - development
    - migration-amplify

app-build-sta:
  stage: build
  allow_failure: false
  cache:
    key: cache_key
    paths:
      - node_modules/
    policy: pull
  script:
    - npm run version:build && npm run build:sta
  artifacts:
    paths:
      - dist
  only:
    - master

# deployment
app-deploy-migration:
  image: cedvdb/ss-gitlab-pipeline-docker
  stage: deploy
  allow_failure: false
  script:
    - cd dist/showsourcing
    - aws s3 sync . s3://app2.showsourcing.com --delete
  only:
    - migration-amplify

app-deploy-dev:
  image: cedvdb/ss-gitlab-pipeline-docker
  stage: deploy
  allow_failure: false
  script:
    - cd dist/showsourcing
    - aws s3 sync . s3://app-dev.showsourcing.com --delete
    - aws s3 cp s3://app-dev.showsourcing.com/index.html s3://app-dev.showsourcing.com/index.html --metadata-directive REPLACE --cache-control max-age=0
  only:
    - development


app-deploy-sta:
  stage: deploy
  allow_failure: false
  when: manual
  script:
    - cd dist/showsourcing
    - aws s3 sync . s3://app-sta.showsourcing.com --delete
    - aws s3 cp s3://app-sta.showsourcing.com/index.html s3://app-sta.showsourcing.com/index.html --metadata-directive REPLACE --cache-control max-age=0
  only:
    - master

app-deploy-prod:
  stage: deploy
  allow_failure: false
  when: manual
  script:
    - cd dist/showsourcing
    - aws s3 sync . s3://app.showsourcing.com --delete
    - aws s3 cp s3://app.showsourcing.com/index.html s3://app.showsourcing.com/index.html --metadata-directive REPLACE --cache-control max-age=0
  only:
    - master


